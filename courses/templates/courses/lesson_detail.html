{% extends 'courses/base.html' %}

{% block title %}{{ lesson.title }} - {{ course.title }}{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'courses:home' %}">í™ˆ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'courses:course_list' %}">ê°•ì˜ ëª©ë¡</a></li>
            <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' course.id %}">{{ course.title }}</a></li>
            <li class="breadcrumb-item active">{{ chapter.title }} - {{ lesson.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Lesson Header -->
            <div class="mb-4">
                <div class="lesson-hierarchy mb-3">
                    <span class="badge bg-primary me-2">ê°•ì˜</span>
                    <span class="text-muted me-3">{{ course.title }}</span>
                    <i class="fas fa-chevron-right text-muted me-3"></i>
                    <span class="badge bg-success me-2">ì±•í„° {{ chapter.order }}</span>
                    <span class="text-muted me-3">{{ chapter.title }}</span>
                    <i class="fas fa-chevron-right text-muted me-3"></i>
                    <span class="badge bg-info me-2">ë ˆìŠ¨ {{ lesson.order }}</span>
                </div>
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="display-5 mb-0">{{ lesson.title }}</h1>
                    
                    <!-- ê³µìœ  ê¸°ëŠ¥ (ê°•ì‚¬ ë˜ëŠ” ê´€ë¦¬ìë§Œ) -->
                    {% if user == course.instructor or user.is_staff %}
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="shareDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-share-alt me-2"></i>ê³µìœ 
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="shareDropdown">
                            <li><h6 class="dropdown-header">ë ˆìŠ¨ ê³µìœ  ì„¤ì •</h6></li>
                            <li>
                                <a class="dropdown-item" href="javascript:void(0)" onclick="toggleLessonShare()">
                                    <i class="fas fa-toggle-{% if lesson.is_public_shareable %}on text-success{% else %}off text-secondary{% endif %} me-2"></i>
                                    ê³µê°œ ê³µìœ  {% if lesson.is_public_shareable %}ì¼œê¸°{% else %}ë„ê¸°{% endif %}
                                </a>
                            </li>
                            {% if lesson.is_public_shareable and lesson.share_token %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="javascript:void(0)" onclick="copyShareUrl()">
                                    <i class="fas fa-copy me-2"></i>ê³µìœ  ë§í¬ ë³µì‚¬
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ lesson.get_share_url }}" target="_blank">
                                    <i class="fas fa-external-link-alt me-2"></i>ë·°ì–´ë¡œ ë³´ê¸°
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                
                <div class="lesson-meta mb-3">
                    {% if lesson.duration %}
                    <span class="badge bg-info me-2">
                        <i class="fas fa-clock"></i> {{ lesson.duration }}
                    </span>
                    {% endif %}
                    {% if lesson.youtube_url %}
                    <span class="badge bg-danger me-2">
                        <i class="fab fa-youtube"></i> ë™ì˜ìƒ ê°•ì˜
                    </span>
                    {% endif %}
                    {% if lesson.is_public_shareable %}
                    <span class="badge bg-success">
                        <i class="fas fa-share-alt"></i> ê³µìœ  ì¤‘
                    </span>
                    {% endif %}
                </div>
                {% if lesson.description %}
                <p class="lead text-muted">{{ lesson.description }}</p>
                {% endif %}
            </div>

            <!-- YouTube Video -->
            {% if lesson.get_youtube_embed_url %}
            <div class="mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">ğŸ¥ ê°•ì˜ ì˜ìƒ</h3>
                    {% if user.is_authenticated %}
                    <div class="youtube-controls">
                        <button id="addNoteBtn" class="btn btn-gradient-primary btn-sm" disabled>
                            <i class="fas fa-sticky-note me-2"></i>ë…¸íŠ¸ ì¶”ê°€
                        </button>
                        <button id="showNotesBtn" class="btn btn-gradient-info btn-sm">
                            <i class="fas fa-comments me-2"></i>ë…¸íŠ¸ ë³´ê¸°
                            <span class="badge bg-light text-dark ms-1">{{ lesson_notes.count }}</span>
                        </button>
                        <small class="text-muted ms-2">
                            ğŸ’¡ Alt+C: íƒ€ì„ìŠ¤íƒ¬í”„ ì‚½ì…
                        </small>
                    </div>
                    {% else %}
                    <div class="youtube-controls">
                        <button id="showNotesBtn" class="btn btn-gradient-info btn-sm">
                            <i class="fas fa-comments me-2"></i>ë…¸íŠ¸ ë³´ê¸°
                            <span class="badge bg-light text-dark ms-1">{{ lesson_notes.count }}</span>
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="youtube-container">
                    <iframe 
                        id="youtube-player"
                        src="{{ lesson.get_youtube_embed_url }}&start={{ start_time }}" 
                        title="{{ lesson.title }}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
            {% endif %}

            <!-- Lesson Content -->
            {% if lesson.content %}
            <div class="mb-5">
                <h3 class="mb-3">ğŸ“– ê°•ì˜ ë‚´ìš©</h3>
                <div class="content-section bg-white p-4 rounded shadow-sm">
                    {{ lesson.content|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Navigation -->
            <div class="lesson-navigation mt-5">
                <div class="row">
                    <div class="col-6">
                        {% if lesson.get_previous_lesson %}
                        <a href="{% url 'courses:lesson_detail' lesson.get_previous_lesson.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-chevron-left"></i> ì´ì „ ë ˆìŠ¨
                            <br><small class="text-muted">{{ lesson.get_previous_lesson.title|truncatechars:20 }}</small>
                        </a>
                        {% endif %}
                    </div>
                    <div class="col-6 text-end">
                        {% if lesson.get_next_lesson %}
                        <a href="{% url 'courses:lesson_detail' lesson.get_next_lesson.id %}" class="btn btn-primary">
                            ë‹¤ìŒ ë ˆìŠ¨ <i class="fas fa-chevron-right"></i>
                            <br><small class="text-white-50">{{ lesson.get_next_lesson.title|truncatechars:20 }}</small>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Course Info -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ğŸ“š ê°•ì˜ ì •ë³´</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ course.title }}</h6>
                    <p class="card-text text-muted">{{ course.description|truncatewords:10 }}</p>
                    <hr>
                    <p class="mb-2">
                        <strong>ê°•ì‚¬:</strong> {{ course.instructor.get_full_name|default:course.instructor.username }}
                    </p>
                    <p class="mb-2">
                        <strong>ì „ì²´ ì±•í„°:</strong> {{ course.get_chapter_count }}ê°œ
                    </p>
                    <p class="mb-0">
                        <strong>ì „ì²´ ë ˆìŠ¨:</strong> {{ course.get_total_lessons }}ê°œ
                    </p>
                </div>
            </div>

            <!-- Current Chapter Info -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ğŸ“– í˜„ì¬ ì±•í„°</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ chapter.order }}. {{ chapter.title }}</h6>
                    {% if chapter.description %}
                    <p class="card-text text-muted">{{ chapter.description|truncatewords:15 }}</p>
                    {% endif %}
                    <p class="mb-0">
                        <strong>ì´ ì±•í„°ì˜ ë ˆìŠ¨:</strong> {{ chapter.get_lesson_count }}ê°œ
                    </p>
                </div>
            </div>

            <!-- Chapter Lessons -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ğŸ“‹ ì´ ì±•í„°ì˜ ë ˆìŠ¨ë“¤</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for chapter_lesson in chapter.get_ordered_lessons %}
                        <div class="list-group-item {% if chapter_lesson.id == lesson.id %}active{% endif %}">
                            {% if chapter_lesson.id == lesson.id %}
                            <div class="d-flex align-items-center">
                                <i class="fas fa-play-circle me-2"></i>
                                <div>
                                    <strong>{{ chapter_lesson.order }}. {{ chapter_lesson.title }}</strong>
                                    <br><small class="text-white-50">í˜„ì¬ ë ˆìŠ¨</small>
                                </div>
                            </div>
                            {% else %}
                            <a href="{% url 'courses:lesson_detail' chapter_lesson.id %}" class="text-decoration-none text-dark">
                                <div class="d-flex align-items-center">
                                    {% if chapter_lesson.youtube_url %}
                                    <i class="fab fa-youtube text-danger me-2"></i>
                                    {% else %}
                                    <i class="fas fa-file-alt me-2"></i>
                                    {% endif %}
                                    <div>
                                        {{ chapter_lesson.order }}. {{ chapter_lesson.title }}
                                        {% if chapter_lesson.duration %}
                                        <br><small class="text-muted">{{ chapter_lesson.duration }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Back to Course -->
            <div class="mt-4">
                <a href="{% url 'courses:course_detail' course.id %}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-arrow-left"></i> ê°•ì˜ë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>

            <!-- Lesson Notes Section -->
            <div class="card mt-4">
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sticky-note me-2"></i>ê³µìœ  ë…¸íŠ¸
                    </h5>
                    {% if user.is_authenticated %}
                    <button id="addNoteSidebar" class="btn btn-light btn-sm">
                        <i class="fas fa-plus"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div id="sidebar-notes-list">
                        <!-- ë…¸íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤
                    </small>
                    <br>
                    <small class="text-muted mt-1">
                        <i class="fas fa-keyboard me-1"></i>
                        í…ìŠ¤íŠ¸ ì…ë ¥ ì¤‘ <kbd>Alt+C</kbd>ë¡œ í˜„ì¬ ì‹œê°„ ì‚½ì…
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë…¸íŠ¸ ì¶”ê°€ ëª¨ë‹¬ -->
{% if user.is_authenticated %}
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-primary text-white border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-sticky-note me-2"></i>
                    <h5 class="modal-title mb-0">ìƒˆ ë…¸íŠ¸ ì‘ì„±</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="noteForm">
                    <div class="timestamp-section mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <span class="fw-bold text-primary">íƒ€ì„ìŠ¤íƒ¬í”„</span>
                        </div>
                        <div class="timestamp-display">
                            <input type="text" id="timestampDisplay" class="form-control form-control-lg bg-light" readonly>
                            <input type="hidden" id="timestampValue">
                        </div>
                    </div>
                    
                    <div class="note-editor-section">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-edit text-primary me-2"></i>
                            <span class="fw-bold text-primary">ë…¸íŠ¸ ë‚´ìš©</span>
                        </div>
                        <div class="note-editor-container">
                            <textarea id="noteContent" class="form-control note-editor" rows="6" 
                                placeholder="ğŸ’­ ì´ ì‹œì ì— ëŒ€í•œ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”...&#10;&#10;â€¢ ì¤‘ìš”í•œ í¬ì¸íŠ¸&#10;â€¢ ì§ˆë¬¸ì‚¬í•­&#10;â€¢ ê°œì¸ì ì¸ ìƒê°"></textarea>
                            <div class="editor-toolbar">
                                <small class="text-muted">
                                    <i class="fas fa-users me-1"></i>
                                    ì´ ë…¸íŠ¸ëŠ” ë‹¤ë¥¸ í•™ìŠµìë“¤ê³¼ ê³µìœ ë©ë‹ˆë‹¤
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light btn-lg" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ì·¨ì†Œ
                </button>
                <button type="button" class="btn btn-primary btn-lg px-4" id="saveNoteBtn">
                    <i class="fas fa-share me-2"></i>ê³µìœ í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ë…¸íŠ¸ ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="notesViewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-info text-white border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-comments me-2"></i>
                    <h5 class="modal-title mb-0">ê³µìœ  ë…¸íŠ¸ â€¢ {{ lesson.title }}</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="notes-header p-4 bg-light border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ë‹¤ë¥¸ í•™ìŠµìë“¤ê³¼ ê³µìœ ëœ ë…¸íŠ¸ë¥¼ í™•ì¸í•˜ê³  ì‹œê°„ëŒ€ë³„ë¡œ í•™ìŠµí•˜ì„¸ìš”
                            </p>
                            <small class="text-muted">íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤</small>
                        </div>
                        {% if user.is_authenticated %}
                        <button type="button" class="btn btn-primary" id="addNoteFromModal">
                            <i class="fas fa-plus me-2"></i>ìƒˆ ë…¸íŠ¸
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="notes-container" style="max-height: 60vh; overflow-y: auto;">
                    <div id="notes-list" class="p-4">
                        <!-- ë…¸íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë…¸íŠ¸ í¸ì§‘ ëª¨ë‹¬ -->
{% if user.is_authenticated %}
<div class="modal fade" id="editNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-warning text-dark border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-edit me-2"></i>
                    <h5 class="modal-title mb-0">ë…¸íŠ¸ ìˆ˜ì •</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editNoteForm">
                    <div class="timestamp-section mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <span class="fw-bold text-warning">íƒ€ì„ìŠ¤íƒ¬í”„</span>
                        </div>
                        <input type="text" id="editTimestampDisplay" class="form-control form-control-lg bg-light" readonly>
                        <input type="hidden" id="editNoteId">
                    </div>
                    
                    <div class="note-editor-section">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-edit text-warning me-2"></i>
                            <span class="fw-bold text-warning">ë…¸íŠ¸ ë‚´ìš©</span>
                        </div>
                        <textarea id="editNoteContent" class="form-control note-editor" rows="6"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-danger btn-lg" id="deleteNoteBtn">
                    <i class="fas fa-trash me-2"></i>ì‚­ì œ
                </button>
                <button type="button" class="btn btn-light btn-lg" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ì·¨ì†Œ
                </button>
                <button type="button" class="btn btn-warning btn-lg px-4" id="updateNoteBtn">
                    <i class="fas fa-save me-2"></i>ìˆ˜ì • ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
.lesson-hierarchy {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    border-left: 4px solid #007bff;
}

.content-section {
    line-height: 1.8;
}

.lesson-navigation {
    border-top: 1px solid #dee2e6;
    padding-top: 2rem;
}

.lesson-navigation .btn {
    height: auto;
    white-space: normal;
    padding: 15px;
}

.list-group-item.active {
    background-color: #3498db;
    border-color: #3498db;
}

.youtube-container {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card-header {
    font-weight: bold;
}

.youtube-controls {
    display: flex;
    gap: 12px;
    align-items: center;
}

.youtube-controls .btn {
    min-width: 120px;
    text-align: center;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ê°œì„  */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.note-editor {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    font-size: 1rem;
    line-height: 1.6;
    resize: vertical;
    transition: all 0.3s ease;
    background: #fafafa;
}

.note-editor:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
    background: white;
}

.note-editor-container {
    position: relative;
}

.editor-toolbar {
    margin-top: 10px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.timestamp-display input {
    text-align: center;
    font-weight: bold;
    color: #007bff;
    font-size: 1.1rem;
}

/* ë…¸íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ê°œì„  */
.note-item {
    border: none;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
}

.note-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.note-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(to bottom, #667eea, #764ba2);
    border-radius: 16px 0 0 16px;
}

.note-timestamp {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
}

.note-timestamp:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    color: white;
    transform: scale(1.05);
}

.note-content {
    margin-top: 15px;
    line-height: 1.7;
    font-size: 1rem;
    color: #333;
    padding: 15px;
    background: rgba(255,255,255,0.7);
    border-radius: 12px;
    border-left: 3px solid #e9ecef;
}

.note-author {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 12px;
    display: flex;
    align-items: center;
}

.note-author::before {
    content: 'ğŸ‘¤';
    margin-right: 6px;
}

.note-actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.empty-notes {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-notes i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #dee2e6;
}

.notes-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
.btn-lg {
    padding: 12px 24px;
    font-weight: 600;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
}

.btn-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border: none;
    color: white;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #e084ea 0%, #e3485a 100%);
    color: white;
}

.dropdown-menu {
    border: none;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    border-radius: 12px;
}

.dropdown-item {
    padding: 10px 16px;
    border-radius: 8px;
    margin: 4px 8px;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background: #f8f9fa;
}

.btn-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 10px;
    padding: 8px 16px;
    transition: all 0.3s ease;
}

.btn-gradient-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    color: white;
    transform: translateY(-1px);
}

.btn-gradient-primary:disabled {
    background: #6c757d;
    opacity: 0.6;
}

.btn-gradient-info {
    background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 10px;
    padding: 8px 16px;
    transition: all 0.3s ease;
}

.btn-gradient-info:hover {
    background: linear-gradient(135deg, #2bc4d1 0%, #4a78d3 100%);
    color: white;
    transform: translateY(-1px);
}

/* ì‚¬ì´ë“œë°” ë…¸íŠ¸ ìŠ¤íƒ€ì¼ */
.sidebar-note-item {
    border-bottom: 1px solid #e9ecef;
    padding: 12px 16px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.sidebar-note-item:hover {
    background: #f8f9fa;
}

.sidebar-note-item:last-child {
    border-bottom: none;
}

.sidebar-note-timestamp {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease;
}

.sidebar-note-timestamp:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    color: white;
    transform: scale(1.05);
}

.sidebar-note-content {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 8px;
    color: #495057;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.sidebar-note-author {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 6px;
}

.sidebar-note-actions {
    margin-top: 8px;
    display: flex;
    gap: 8px;
}

.sidebar-note-actions .btn {
    padding: 2px 6px;
    font-size: 0.75rem;
}

.empty-sidebar-notes {
    text-align: center;
    padding: 30px 20px;
    color: #6c757d;
}

.empty-sidebar-notes i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #dee2e6;
}

/* ë…¸íŠ¸ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#notesToggleBtn {
    border-radius: 8px;
    transition: all 0.2s ease;
}

#notesToggleBtn:hover {
    background: rgba(255,255,255,0.9);
    transform: scale(1.05);
}

#notesToggleIcon {
    transition: transform 0.2s ease;
}
</style>

{% if lesson.get_youtube_embed_url %}
<script>
// YouTube API ê´€ë ¨ ë³€ìˆ˜
let player;
let isPlayerReady = false;

// YouTube API ë¡œë“œ
function onYouTubeIframeAPIReady() {
    player = new YT.Player('youtube-player', {
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
        }
    });
}

function onPlayerReady(event) {
    isPlayerReady = true;
    {% if user.is_authenticated %}
    document.getElementById('addNoteBtn').disabled = false;
    {% endif %}
    
    // ì‹œì‘ ì‹œê°„ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì‹œê°„ìœ¼ë¡œ ì´ë™
    const startTime = {{ start_time }};
    if (startTime > 0) {
        player.seekTo(startTime, true);
    }
}

function onPlayerStateChange(event) {
    // í•„ìš”ì‹œ ìƒíƒœ ë³€í™” ì²˜ë¦¬
}

// í˜„ì¬ ì¬ìƒ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
function getCurrentTime() {
    if (isPlayerReady && player) {
        return Math.floor(player.getCurrentTime());
    }
    return 0;
}

// íŠ¹ì • ì‹œê°„ìœ¼ë¡œ ì´ë™
function seekToTime(seconds) {
    if (isPlayerReady && player) {
        player.seekTo(seconds, true);
    }
}

// ì‹œê°„ì„ MM:SS í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

{% if user.is_authenticated %}
// í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
document.addEventListener('keydown', function(e) {
    // Alt + C í‚¤ ì¡°í•© - íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    if (e.altKey && e.key.toLowerCase() === 'c') {
        e.preventDefault();
        insertTimestampAtCursor();
    }
});

// í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— íƒ€ì„ìŠ¤íƒ¬í”„ ì‚½ì…
function insertTimestampAtCursor() {
    const currentTime = getCurrentTime();
    const timeDisplay = formatTime(currentTime);
    const timestampText = `[${timeDisplay}] `;
    
    // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œ ì°¾ê¸°
    const activeElement = document.activeElement;
    
    if (activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT')) {
        // í…ìŠ¤íŠ¸ ì˜ì—­ì´ë‚˜ ì…ë ¥ í•„ë“œì— íƒ€ì„ìŠ¤íƒ¬í”„ ì‚½ì…
        const start = activeElement.selectionStart;
        const end = activeElement.selectionEnd;
        const text = activeElement.value;
        
        activeElement.value = text.substring(0, start) + timestampText + text.substring(end);
        
        // ì»¤ì„œë¥¼ íƒ€ì„ìŠ¤íƒ¬í”„ ë’¤ë¡œ ì´ë™
        const newPos = start + timestampText.length;
        activeElement.setSelectionRange(newPos, newPos);
        activeElement.focus();
        
        // ì„±ê³µ ì•Œë¦¼
        showToast(`íƒ€ì„ìŠ¤íƒ¬í”„ [${timeDisplay}]ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    } else {
        // í¬ì»¤ìŠ¤ëœ í…ìŠ¤íŠ¸ í•„ë“œê°€ ì—†ìœ¼ë©´ ë…¸íŠ¸ ëª¨ë‹¬ ì—´ê¸°
        showToast('í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ë¥¼ ë§ì¶”ê³  Alt+Cë¥¼ ëˆ„ë¥´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì‚½ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        addNoteAtCurrentTime();
    }
}

// ë…¸íŠ¸ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('addNoteBtn').addEventListener('click', addNoteAtCurrentTime);
document.getElementById('addNoteFromModal').addEventListener('click', addNoteAtCurrentTime);

// í˜„ì¬ ì‹œê°„ì— ë…¸íŠ¸ ì¶”ê°€
function addNoteAtCurrentTime() {
    const currentTime = getCurrentTime();
    const timeDisplay = formatTime(currentTime);
    
    // ë…¸íŠ¸ ë³´ê¸° ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
    const notesModal = bootstrap.Modal.getInstance(document.getElementById('notesViewModal'));
    if (notesModal) {
        notesModal.hide();
    }
    
    document.getElementById('timestampDisplay').value = timeDisplay;
    document.getElementById('timestampValue').value = currentTime;
    document.getElementById('noteContent').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('noteModal'));
    modal.show();
    
    // ëª¨ë‹¬ì´ ì—´ë¦° í›„ í…ìŠ¤íŠ¸ ì˜ì—­ì— í¬ì»¤ìŠ¤
    modal._element.addEventListener('shown.bs.modal', function() {
        document.getElementById('noteContent').focus();
    });
}

// ë…¸íŠ¸ ì €ì¥
document.getElementById('saveNoteBtn').addEventListener('click', function() {
    const content = document.getElementById('noteContent').value.trim();
    const timestamp = parseInt(document.getElementById('timestampValue').value);
    
    if (!content) {
        alert('ë…¸íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch('{% url "courses:create_note" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lesson_id: {{ lesson.id }},
            timestamp: timestamp,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('noteModal'));
            modal.hide();
            
            // ë…¸íŠ¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            updateNoteCount();
            
            // ì„±ê³µ ë©”ì‹œì§€
            showToast('ë…¸íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            alert('ë…¸íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë…¸íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});
{% endif %}

// ë…¸íŠ¸ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('showNotesBtn').addEventListener('click', function() {
    loadNotes();
    const modal = new bootstrap.Modal(document.getElementById('notesViewModal'));
    modal.show();
});

// ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ
function loadNotes() {
    fetch('{% url "courses:get_lesson_notes" lesson.id %}')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('notes-list');
        container.innerHTML = '';
        
        if (data.notes.length === 0) {
            container.innerHTML = `
                <div class="empty-notes">
                    <i class="fas fa-sticky-note"></i>
                    <h5>ì•„ì§ ê³µìœ ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p class="text-muted">ì²« ë²ˆì§¸ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>
            `;
            return;
        }
        
        data.notes.forEach(note => {
            const noteElement = createNoteElement(note);
            container.appendChild(noteElement);
        });
    })
    .catch(error => {
        console.error('Error loading notes:', error);
    });
}

// ë…¸íŠ¸ ìš”ì†Œ ìƒì„±
function createNoteElement(note) {
    const div = document.createElement('div');
    div.className = 'note-item';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                    <a href="#" class="note-timestamp me-3" onclick="seekToTime(${note.timestamp}); return false;">
                        ğŸ“ ${note.timestamp_display}
                    </a>
                    <small class="note-author">${note.author}</small>
                </div>
                <div class="note-content">${note.content}</div>
            </div>
            ${note.is_own ? `
            <div class="dropdown ms-3">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" 
                        style="border-radius: 12px;">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item edit-note-btn" href="#" 
                           data-note-id="${note.id}" 
                           data-timestamp="${note.timestamp_display}" 
                           data-content="${note.content.replace(/"/g, '&quot;')}">
                        <i class="fas fa-edit text-warning me-2"></i>ìˆ˜ì •í•˜ê¸°
                    </a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteNote('${note.id}')">
                        <i class="fas fa-trash me-2"></i>ì‚­ì œí•˜ê¸°
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="${note.share_url}" target="_blank">
                        <i class="fas fa-external-link-alt text-primary me-2"></i>ê³µìœ  ë§í¬
                    </a></li>
                </ul>
            </div>
            ` : ''}
        </div>
    `;
    
    // í¸ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const editBtn = div.querySelector('.edit-note-btn');
    if (editBtn) {
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const noteId = this.dataset.noteId;
            const timestamp = this.dataset.timestamp;
            const content = this.dataset.content;
            editNote(noteId, timestamp, content);
        });
    }
    
    return div;
}

{% if user.is_authenticated %}
// ë…¸íŠ¸ í¸ì§‘
function editNote(noteId, timestamp, content) {
    document.getElementById('editNoteId').value = noteId;
    document.getElementById('editTimestampDisplay').value = timestamp;
    document.getElementById('editNoteContent').value = content;
    
    // ë…¸íŠ¸ ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
    const notesModal = bootstrap.Modal.getInstance(document.getElementById('notesViewModal'));
    if (notesModal) {
        notesModal.hide();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('editNoteModal'));
    modal.show();
}

// ë…¸íŠ¸ ìˆ˜ì •
document.getElementById('updateNoteBtn').addEventListener('click', function() {
    const noteId = document.getElementById('editNoteId').value;
    const content = document.getElementById('editNoteContent').value.trim();
    
    if (!content) {
        alert('ë…¸íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/api/notes/${noteId}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editNoteModal'));
            modal.hide();
            showToast('ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            alert('ë…¸íŠ¸ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë…¸íŠ¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});

// ë…¸íŠ¸ ì‚­ì œ
document.getElementById('deleteNoteBtn').addEventListener('click', function() {
    if (!confirm('ì •ë§ë¡œ ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const noteId = document.getElementById('editNoteId').value;
    deleteNote(noteId);
});

function deleteNote(noteId) {
    fetch(`/api/notes/${noteId}/`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editNoteModal'));
            if (editModal) {
                editModal.hide();
            }
            updateNoteCount();
            showToast('ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        } else {
            alert('ë…¸íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë…¸íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}
{% endif %}

// ë…¸íŠ¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸
function updateNoteCount() {
    fetch('{% url "courses:get_lesson_notes" lesson.id %}')
    .then(response => response.json())
    .then(data => {
        const button = document.getElementById('showNotesBtn');
        button.innerHTML = `
            <i class="fas fa-comments me-2"></i>ë…¸íŠ¸ ë³´ê¸°
            <span class="badge bg-light text-dark ms-1">${data.notes.length}</span>
        `;
    });
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
function showToast(message, type = 'info') {
    // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ì•Œë¦¼ (í•„ìš”ì‹œ Bootstrap Toastë¡œ ëŒ€ì²´ ê°€ëŠ¥)
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'warning'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'}"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// YouTube API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
if (!window.YT) {
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ì´ë“œë°” ë…¸íŠ¸ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    loadSidebarNotes();
});

// ì‚¬ì´ë“œë°” ë…¸íŠ¸ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
{% if user.is_authenticated %}
document.getElementById('addNoteSidebar').addEventListener('click', addNoteAtCurrentTime);
{% endif %}

// ì‚¬ì´ë“œë°” ë…¸íŠ¸ ë¡œë“œ
function loadSidebarNotes() {
    fetch('{% url "courses:get_lesson_notes" lesson.id %}')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('sidebar-notes-list');
        container.innerHTML = '';
        
        if (data.notes.length === 0) {
            container.innerHTML = `
                <div class="empty-sidebar-notes">
                    <i class="fas fa-sticky-note"></i>
                    <p class="mb-1">ì•„ì§ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <small class="text-muted">ì²« ë²ˆì§¸ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</small>
                </div>
            `;
            return;
        }
        
        data.notes.forEach(note => {
            const noteElement = createSidebarNoteElement(note);
            container.appendChild(noteElement);
        });
    })
    .catch(error => {
        console.error('Error loading sidebar notes:', error);
        document.getElementById('sidebar-notes-list').innerHTML = `
            <div class="empty-sidebar-notes">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <p class="mb-0">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        `;
    });
}

// ì‚¬ì´ë“œë°” ë…¸íŠ¸ ìš”ì†Œ ìƒì„±
function createSidebarNoteElement(note) {
    const div = document.createElement('div');
    div.className = 'sidebar-note-item';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <a href="#" class="sidebar-note-timestamp" onclick="seekToTime(${note.timestamp}); return false;">
                    ${note.timestamp_display}
                </a>
                <div class="sidebar-note-content">${note.content}</div>
                <div class="sidebar-note-author">ğŸ‘¤ ${note.author}</div>
                ${note.is_own ? `
                <div class="sidebar-note-actions">
                    <button class="btn btn-outline-warning btn-sm edit-sidebar-note" 
                            data-note-id="${note.id}" 
                            data-timestamp="${note.timestamp_display}" 
                            data-content="${note.content.replace(/"/g, '&quot;')}">
                        <i class="fas fa-edit"></i> ìˆ˜ì •
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteSidebarNote('${note.id}')">
                        <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // í¸ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const editBtn = div.querySelector('.edit-sidebar-note');
    if (editBtn) {
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const noteId = this.dataset.noteId;
            const timestamp = this.dataset.timestamp;
            const content = this.dataset.content;
            editNote(noteId, timestamp, content);
        });
    }
    
    return div;
}

{% if user.is_authenticated %}
// ì‚¬ì´ë“œë°”ì—ì„œ ë…¸íŠ¸ ì‚­ì œ
function deleteSidebarNote(noteId) {
    if (!confirm('ì •ë§ë¡œ ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    deleteNote(noteId);
}
{% endif %}

// ê¸°ì¡´ í•¨ìˆ˜ë“¤ ìˆ˜ì • - ì‚¬ì´ë“œë°” ë…¸íŠ¸ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
const originalUpdateNoteCount = updateNoteCount;
function updateNoteCount() {
    originalUpdateNoteCount();
    loadSidebarNotes(); // ì‚¬ì´ë“œë°” ë…¸íŠ¸ë„ ìƒˆë¡œê³ ì¹¨
}

// ë ˆìŠ¨ ê³µìœ  ê¸°ëŠ¥
{% if user == course.instructor or user.is_staff %}
// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    // meta íƒœê·¸ì—ì„œ ì‹œë„
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    // ì¿ í‚¤ì—ì„œ ì‹œë„
    const csrfCookie = document.cookie.split(';').find(cookie => cookie.trim().startsWith('csrftoken='));
    if (csrfCookie) {
        return csrfCookie.split('=')[1];
    }
    console.warn('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return '';
}

function toggleLessonShare() {
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        alert('ë³´ì•ˆ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
        return;
    }

    fetch(`/api/lessons/{{ lesson.id }}/toggle-share/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ê³µìœ  ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            setTimeout(() => {
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸
            }, 1000);
        } else {
            alert('ê³µìœ  ì„¤ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ê³µìœ  ì„¤ì • ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

function copyShareUrl() {
    const shareUrl = window.location.protocol + '//' + window.location.host + '{{ lesson.get_share_url }}';
    
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }).catch(err => {
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            fallbackCopyTextToClipboard(shareUrl);
        });
    } else {
        fallbackCopyTextToClipboard(shareUrl);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } catch (err) {
        console.error('í´ë°± ë³µì‚¬ ì‹¤íŒ¨:', err);
        showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”: ' + text, 'warning');
    }
    
    document.body.removeChild(textArea);
}
{% endif %}
</script>
{% endif %}
{% endblock %} 